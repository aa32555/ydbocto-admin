stages:
  - test

variables:
  GOLANG_VERSION: 1.11.2

before_script:
  - apt-get update -qq && apt-get install -y -qq --no-install-recommends build-essential cmake bison flex libcmocka-dev python-pip libreadline-dev git libconfig-dev libssl-dev postgresql-client xxd wget ca-certificates g++ gcc libc6-dev make pkg-config && rm -rf /var/lib/apt/lists/*
  - pip install sphinxcontrib-fulltoc sphinx sphinx_rtd_theme
  - export GOPATH=/go
  - mkdir -p ${GOPATH}/src ${GOPATH}/bin && chmod -R 777 ${GOPATH}
  - mkdir -p ${GOPATH}/src/lang.yottadb.com/go/yottadb/.git ${GOPATH}/src/_/builds
  - cp -r $CI_PROJECT_DIR/* ${GOPATH}/src/lang.yottadb.com/go/yottadb
  - cp -r $CI_PROJECT_DIR/.git/* ${GOPATH}/src/lang.yottadb.com/go/yottadb/.git
  - ln -s ${GOPATH}/src/lang.yottadb.com/go/yottadb ${GOPATH}/src/_/builds/yottadb
  - export PATH=$GOPATH/bin:/usr/local/go/bin:$PATH
  - wget -O go.tgz -q https://golang.org/dl/go${GOLANG_VERSION}.linux-amd64.tar.gz
  - tar -C /usr/local -xzf go.tgz
  - rm go.tgz
  - go version
  - cd ${GOPATH}/src/lang.yottadb.com/go/yottadb
  - export ydb_dist=/opt/yottadb/current
  - export ydb_gbldir=mumps.gld
  - export ydb_routines=/opt/yottadb/current/libyottadbutil.so
  - echo exit | /opt/yottadb/current/mumps -run ^GDE
  - /opt/yottadb/current/mupip create
  - mkdir -p $CI_PROJECT_DIR/artifacts

unit_tests:
  stage: test
  script:
    - export ydb_routines=". m_routines/ $ydb_routines"
    - export YDB_GO_SKIP_TIMED_TESTS="yes"
    - go get -t
    - go test -short $(go list ./... | grep -v /vendor/)
    - cp -r . $CI_PROJECT_DIR/artifacts
  artifacts:
    paths:
      - artifacts
    expire_in: 7 days
